import React, { useState, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { motion } from 'framer-motion';
import { 
  ArrowLeft, User, Crown, Bell, Receipt, 
  LogOut, ChevronRight, Sparkles, Check, Loader2
} from 'lucide-react';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import UpgradeModal from '@/components/premium/UpgradeModal';

export default function Settings() {
  const [user, setUser] = useState(null);
  const [showUpgradeModal, setShowUpgradeModal] = useState(false);
  const queryClient = useQueryClient();

  useEffect(() => {
    const loadUser = async () => {
      try {
        const u = await base44.auth.me();
        setUser(u);
      } catch {
        // Not logged in
      }
    };
    loadUser();
  }, []);

  const { data: subscriptions = [], isLoading: subLoading } = useQuery({
    queryKey: ['subscription'],
    queryFn: () => base44.entities.UserSubscription.filter({ created_by: user?.email }),
    enabled: !!user?.email,
  });

  const subscription = subscriptions[0] || { 
    tier: 'free', 
    receipts_scanned_this_month: 0,
    notification_settings: {
      spending_alerts: true,
      weekly_summary: true,
      budget_warnings: true
    }
  };

  const isPremium = subscription.tier === 'premium';

  const upgradeMutation = useMutation({
    mutationFn: async () => {
      if (subscription.id) {
        return base44.entities.UserSubscription.update(subscription.id, { tier: 'premium' });
      } else {
        return base44.entities.UserSubscription.create({ tier: 'premium' });
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['subscription'] });
      setShowUpgradeModal(false);
    },
  });

  const updateNotificationsMutation = useMutation({
    mutationFn: async (settings) => {
      if (subscription.id) {
        return base44.entities.UserSubscription.update(subscription.id, { 
          notification_settings: settings 
        });
      } else {
        return base44.entities.UserSubscription.create({ 
          tier: 'free',
          notification_settings: settings 
        });
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['subscription'] });
    },
  });

  const handleLogout = () => {
    base44.auth.logout();
  };

  const toggleNotification = (key) => {
    const newSettings = {
      ...subscription.notification_settings,
      [key]: !subscription.notification_settings?.[key]
    };
    updateNotificationsMutation.mutate(newSettings);
  };

  const getInitials = (name) => {
    if (!name) return 'U';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
  };

  return (
    <div className="min-h-screen bg-slate-50">
      {/* Header */}
      <div className="bg-white border-b border-slate-100 sticky top-0 z-20">
        <div className="max-w-lg mx-auto px-4 py-4">
          <div className="flex items-center gap-3">
            <Link 
              to={createPageUrl('Home')}
              className="p-2 -ml-2 hover:bg-slate-100 rounded-xl transition-colors"
            >
              <ArrowLeft className="w-5 h-5 text-slate-600" />
            </Link>
            <h1 className="text-xl font-bold text-slate-900">Settings</h1>
          </div>
        </div>
      </div>

      <div className="max-w-lg mx-auto px-4 py-6 pb-24">
        {/* Profile Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="bg-white rounded-3xl p-6 border border-slate-100 mb-6"
        >
          <div className="flex items-center gap-4">
            <Avatar className="w-16 h-16">
              <AvatarFallback className="bg-gradient-to-br from-emerald-500 to-teal-600 text-white text-xl font-semibold">
                {getInitials(user?.full_name)}
              </AvatarFallback>
            </Avatar>
            <div className="flex-1">
              <h2 className="text-lg font-semibold text-slate-900">{user?.full_name || 'User'}</h2>
              <p className="text-sm text-slate-500">{user?.email}</p>
              <div className="flex items-center gap-2 mt-2">
                {isPremium ? (
                  <span className="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-full">
                    <Crown className="w-3 h-3" />
                    Premium
                  </span>
                ) : (
                  <span className="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium bg-slate-100 text-slate-600 rounded-full">
                    Free Plan
                  </span>
                )}
              </div>
            </div>
          </div>
        </motion.div>

        {/* Subscription Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          className="bg-white rounded-3xl border border-slate-100 mb-6 overflow-hidden"
        >
          <div className="p-4 border-b border-slate-100">
            <h3 className="font-semibold text-slate-900">Subscription</h3>
          </div>
          
          {!isPremium && (
            <button
              onClick={() => setShowUpgradeModal(true)}
              className="w-full p-4 flex items-center gap-4 hover:bg-slate-50 transition-colors"
            >
              <div className="p-2 rounded-xl bg-gradient-to-br from-violet-100 to-purple-100">
                <Sparkles className="w-5 h-5 text-violet-600" />
              </div>
              <div className="flex-1 text-left">
                <p className="font-medium text-slate-900">Upgrade to Premium</p>
                <p className="text-sm text-slate-500">Unlock all features for $4.99/month</p>
              </div>
              <ChevronRight className="w-5 h-5 text-slate-400" />
            </button>
          )}

          <div className="p-4 flex items-center gap-4 border-t border-slate-100">
            <div className="p-2 rounded-xl bg-emerald-100">
              <Receipt className="w-5 h-5 text-emerald-600" />
            </div>
            <div className="flex-1">
              <p className="font-medium text-slate-900">Receipt Scans</p>
              <p className="text-sm text-slate-500">
                {isPremium ? 'Unlimited' : `${subscription.receipts_scanned_this_month || 0}/5 this month`}
              </p>
            </div>
            {isPremium && <Check className="w-5 h-5 text-emerald-500" />}
          </div>
        </motion.div>

        {/* Notifications Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.2 }}
          className="bg-white rounded-3xl border border-slate-100 mb-6 overflow-hidden"
        >
          <div className="p-4 border-b border-slate-100">
            <h3 className="font-semibold text-slate-900">Notifications</h3>
          </div>
          
          <div className="p-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="p-2 rounded-xl bg-blue-100">
                <Bell className="w-5 h-5 text-blue-600" />
              </div>
              <div>
                <p className="font-medium text-slate-900">Spending Alerts</p>
                <p className="text-sm text-slate-500">Get notified for unusual spending</p>
              </div>
            </div>
            <Switch
              checked={subscription.notification_settings?.spending_alerts ?? true}
              onCheckedChange={() => toggleNotification('spending_alerts')}
            />
          </div>

          <div className="p-4 flex items-center justify-between border-t border-slate-100">
            <div className="flex items-center gap-4">
              <div className="p-2 rounded-xl bg-purple-100">
                <Bell className="w-5 h-5 text-purple-600" />
              </div>
              <div>
                <p className="font-medium text-slate-900">Weekly Summary</p>
                <p className="text-sm text-slate-500">Receive weekly spending reports</p>
              </div>
            </div>
            <Switch
              checked={subscription.notification_settings?.weekly_summary ?? true}
              onCheckedChange={() => toggleNotification('weekly_summary')}
            />
          </div>

          <div className="p-4 flex items-center justify-between border-t border-slate-100">
            <div className="flex items-center gap-4">
              <div className="p-2 rounded-xl bg-amber-100">
                <Bell className="w-5 h-5 text-amber-600" />
              </div>
              <div>
                <p className="font-medium text-slate-900">Budget Warnings</p>
                <p className="text-sm text-slate-500">Alert when nearing budget limits</p>
              </div>
            </div>
            <Switch
              checked={subscription.notification_settings?.budget_warnings ?? true}
              onCheckedChange={() => toggleNotification('budget_warnings')}
            />
          </div>
        </motion.div>

        {/* Logout Button */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
        >
          <Button
            variant="outline"
            onClick={handleLogout}
            className="w-full h-12 rounded-xl text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200"
          >
            <LogOut className="w-4 h-4 mr-2" />
            Log Out
          </Button>
        </motion.div>
      </div>

      {/* Upgrade Modal */}
      <UpgradeModal
        isOpen={showUpgradeModal}
        onClose={() => setShowUpgradeModal(false)}
        onUpgrade={() => upgradeMutation.mutate()}
      />
    </div>
  );
}